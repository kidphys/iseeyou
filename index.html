<!DOCTYPE html>
<html>
<head>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
    .buy rect {
        fill: green;
    }

    .buy text {
      fill: green;
      font: 10px sans-serif;
      text-anchor: end;
    }

    .sell rect {
        fill: red;
    }

    .sell text {
      fill: red;
      font: 10px sans-serif;
      text-anchor: end;
    }

    .time {
      fill: steelblue;
      font: 30px sans-serif;
      text-anchor: end;
    }

/*    .chart rect {
      fill: steelblue;
  }

  .chart text {
      fill: steelblue;
      font: 10px sans-serif;
      text-anchor: end;
  }
*/  </style>
</head>
<body>
    <svg class="chart"></svg>
    <script src="stock.js" charset="utf-8"></script>
    <script src="visualize.js" charset="utf-8"></script>
    <script src="moment.min.js" charset="utf-8"></script>
    <script type="text/javascript">

    var width = 960, height = 500;

    var y = d3.scale.linear()
    .range([height, 0]);

    var chart = d3.select(".chart")
    .attr("width", width)
    .attr("height", height);


    // display time
    chart.append('text')
        .attr('class', 'time')
        .attr('x', 150)
        .attr('y', 200)
        .text('09:00:00')

    y.domain([0, 10000]);

    function type(d) {
      d.value = +d.value; // coerce to number
      return d;
    }

    function gen_array(size){
        var data = Array.apply(null, new Array(size));
        return data.map(function(){return {'value': 0, 'class': 'buy'};});
    }

    load('1224_VND.json', function(stocks){
        var stock = stocks[0];
        var floorPrice = stock.floorPrice;
        var data = gen_array(price_step_count(stock));
        var now = moment('09:00:00', 'hh:mm:ss');
        var timeStep = 30; // seconds
        var i = 0;
        function next(){
            if (i >= stocks.length){
                return null;
            }

            chart.select('.time').text(now.format('hh:mm'));
            var ans = reduce_obj(stocks[i]);
            if (moment(ans.time, 'hh:mm:ss') < now){
                i++;
                return ans;
            }
            else{
                now.add(timeStep, 'seconds');
                return null;
            }
        }

        setInterval(function(){
            tick = next();
            if (tick != null){
                tick.stock.map(function(d){
                    try{
                        data[index(d.price, floorPrice)].value = d.quantity;
                        data[index(d.price, floorPrice)].class = d.class;
                    }
                    catch(e){
                        console.log(d.price, index(d.price, floorPrice));
                    }
                });
                update(chart, data);
            }
        }, 50);
    });

</script>
</body>
</html>